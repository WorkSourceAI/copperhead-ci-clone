name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - name: Set base path
        id: base
        run: |
          repo_name="${GITHUB_REPOSITORY#*/}"
          echo "base=/${repo_name}/" >> "$GITHUB_OUTPUT"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Install dependencies
        working-directory: frontend
        run: |
          yarn install --frozen-lockfile || yarn install

      - name: Build
        working-directory: frontend
        env:
          GH_PAGES_BASE: ${{ steps.base.outputs.base }}
        run: |
          yarn build
          # Always copy index.html to 404.html for SPA fallback (simpler than redirect script)
          cp dist/index.html dist/404.html
          echo "Build complete with base=${GH_PAGES_BASE}"
          echo "Listing dist root:" && ls -al dist
          echo "Finding key files:" && find dist -maxdepth 2 -type f -name 'index.html' -o -name '404.html' -o -name '*.js'
          # Sanity check: fail if index.html missing
          if [ ! -f dist/index.html ]; then echo 'ERROR: index.html not found after build' >&2; exit 1; fi
          if [ ! -s dist/index.html ]; then echo 'ERROR: index.html is empty' >&2; exit 1; fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/dist

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Output Deployed URL
        run: echo "Deployed to ${{ steps.deploy.outputs.page_url }}"
